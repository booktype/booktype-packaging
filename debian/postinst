#!/bin/bash
#postinst script for Booktype

set -e

if [ "$DPKG_DEBUG" = "developer" ]; then
    set -x
fi

case "$1" in
  configure|reconfigure)

    VIRTUAL_ENV_DIR="/var/lib/booktype/"
    DEFAULT_INSTANCE_DIR="/var/www/booktype/"
    DEFAULT_INSTANCE_NAME="instance1"

    echo -e "\n*** Installing Python libraries ***"
    ${VIRTUAL_ENV_DIR}bin/pip install ${VIRTUAL_ENV_DIR}booktype-dependencies.pybundle || exit 1

    echo -e "\n*** Activating virtualenv ***"
    source ${VIRTUAL_ENV_DIR}bin/activate

    echo -e "\n*** Creating Booktype instance ***"
    if [ ! -d ${DEFAULT_INSTANCE_DIR} ]; then
      mkdir -p ${DEFAULT_INSTANCE_DIR}
    fi

    if [ ! -d ${DEFAULT_INSTANCE_DIR}${DEFAULT_INSTANCE_NAME} ]; then
      ${VIRTUAL_ENV_DIR}scripts/createbooktype --check-versions --database postgresql ${DEFAULT_INSTANCE_DIR}${DEFAULT_INSTANCE_NAME}
    fi

    echo -e "\n*** Installing symlinks for fonts ***"
    if [ ! -h ${VIRTUAL_ENV_DIR}lib/booktype/apps/core/static/core/css/font-awesome/css ] && [ -d /usr/share/fonts-font-awesome/css ]; then
       ln -s /usr/share/fonts-font-awesome/css ${VIRTUAL_ENV_DIR}lib/booktype/apps/core/static/core/css/font-awesome/css
    fi
    if [ ! -h ${VIRTUAL_ENV_DIR}lib/booktype/apps/core/static/core/css/font-awesome/font ] && [ -d /usr/share/fonts-font-awesome/fonts ]; then
       ln -s /usr/share/fonts-font-awesome/fonts ${VIRTUAL_ENV_DIR}lib/booktype/apps/core/static/core/css/font-awesome/font
    fi

  ;;

  abort-upgrade|abort-remove|abort-deconfigure)
  ;;

  *)
       echo "postinst called with unknown argument \`$1'" >&2
       exit 1
  ;;
esac

#DEBHELPER#

exit 0
