#!/bin/bash
#postinst script for Booktype

set -e

. /usr/share/debconf/confmodule

if [ "$DPKG_DEBUG" = "developer" ]; then
    set -x
fi

    CONFIG_DIR="/etc/booktype/2.0/"
    APACHE_TEMPLATE="${CONFIG_DIR}apache.vhost.tpl"

    DEFAULT_INSTANCE_DIR="/var/www/booktype/"
    DEFAULT_INSTANCE_NAME="instance1"
    DEFAULT_INSTANCE_SETTINGS="${DEFAULT_INSTANCE_DIR}${DEFAULT_INSTANCE_NAME}/${DEFAULT_INSTANCE_NAME}_site/settings/"

    DOMAIN_NAME="$(hostname --fqdn)"
    TIME_ZONE="$(cat /etc/timezone)"

    VIRTUAL_ENV_DIR="/var/lib/booktype/"

case "$1" in
  configure|reconfigure)

    echo -e "\n*** Installing Python libraries ***"
    ${VIRTUAL_ENV_DIR}bin/pip install ${VIRTUAL_ENV_DIR}booktype-dependencies.pybundle || exit 1

    db_get booktype/server-setup
      if [ "$RET" == "yes please" ]; then

        echo "*** Beginning automatic configuration ***"

        echo -e "\n*** Activating virtualenv ***"
        source ${VIRTUAL_ENV_DIR}bin/activate
        echo -e "\n Virtualenv in ${VIRTUAL_ENV_DIR} activated"

        echo -e "\n*** Creating Booktype instance ***"
        if [ ! -d ${DEFAULT_INSTANCE_DIR} ]; then
          mkdir -p ${DEFAULT_INSTANCE_DIR}
        fi

        if [ ! -d ${DEFAULT_INSTANCE_DIR}${DEFAULT_INSTANCE_NAME} ]; then
          ${VIRTUAL_ENV_DIR}scripts/createbooktype --check-versions --profile prod --database postgresql ${DEFAULT_INSTANCE_DIR}${DEFAULT_INSTANCE_NAME}

          echo "*** Setting database parameters ***"

          db_get booktype/database-name
          DATABASE_NAME=$RET
          sed -i "s/'NAME': ''/'NAME': '${DATABASE_NAME}'/" ${DEFAULT_INSTANCE_SETTINGS}prod.py

          db_get booktype/database-user
          DATABASE_USER=$RET
          sed -i "s/'USER': ''/'USER': '${DATABASE_USER}'/" ${DEFAULT_INSTANCE_SETTINGS}prod.py

          db_get booktype/database-password
          DATABASE_PASSWORD=$RET
          sed -i "s/'PASSWORD: ''/'PASSWORD': '${DATABASE_PASSWORD}'/" ${DEFAULT_INSTANCE_SETTINGS}prod.py

          db_get booktype/database-host
          DATABASE_HOST=$RET
          sed -i "s/'HOST': ''/'HOST': '${DATABASE_HOST}'/" ${DEFAULT_INSTANCE_SETTINGS}prod.py

          db_get booktype/database-port
          DATABASE_PORT=$RET
          sed -i "s/'PORT': ''/'PORT': '${DATABASE_PORT}'/" ${DEFAULT_INSTANCE_SETTINGS}prod.py

          # If the user has not entered a FQDN, set it from the hostname
          echo -e "\n*** Setting default instance name to ${DOMAIN_NAME} ***"

          cd ${DEFAULT_INSTANCE_DIR}${DEFAULT_INSTANCE_NAME}
          #./manage.py syncdb --noinput
          #./manage.py migrate
          #./manage.py collectstatic
          #./manage.py createsuperuser

        else
          echo -e "\n Directory already exists in ${DEFAULT_INSTANCE_DIR}${DEFAULT_INSTANCE_NAME}!"
          echo -e "\n Skipping instance creation!"
        fi

      else
        echo "*** Not performing automatic configuration ***"
      fi
  ;;

  abort-upgrade|abort-remove|abort-deconfigure)
  ;;

  *)
       echo "postinst called with unknown argument \`$1'" >&2
       exit 1
  ;;
esac

#DEBHELPER#

exit 0
